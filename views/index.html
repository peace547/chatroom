<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>simple chatroom</title>
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_844402_rkg4k3gw6jd.css">
    <link href="https://cdn.bootcss.com/emojione/2.2.7/assets/css/emojione.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/emojione/2.2.7/assets/sprites/emojione.sprites.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/index.css">
</head>

<body>
    <div class="chatroom">
        <div class="mask"></div>
        <div class="area">
            <div class="head_area">
                <input type="file" id="avaterInput" style="display: none">
                <div class="uploadAvater"><i class="iconfont icon-touxiang"></i></div>
                <div style="color: #fff">ÁÇπÂáª‰∏ä‰º†/Êõ¥ÊîπÂ§¥ÂÉè</div>
            </div>
            <div>
                <input autofocus type="text" class="input_name" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó">
                <button id="coming" style="float:left">ÁôªÂΩï</button>
            </div>
        </div>
        <div class="header">ËÅäÂ§©ÂÆ§</div>
        <ul class="container">
        </ul>
        <div class="footer">
            <div class="input_bar">
                <div class="right_input">
                    <textarea id="pre" class="public"></textarea>
                    <textarea id="textarea" class="public"></textarea>
                </div>
                <button id="send" class="send">ÂèëÈÄÅ</button>
            </div>
            <div class="bar_line">
                <div><i class="iconfont icon-tupian1"></i><input type="file" id="fileInput" style="display: none"></div>
                <div id="face_area"><i class="iconfont icon-biaoqing"></i></div>
            </div>
            <div class="faceList"></div>
        </div>
    </div>
</body>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/socket.io/2.1.1/socket.io.js"></script>
<script src="https://cdn.bootcss.com/emojione/2.2.7/lib/js/emojione.min.js"></script>
<script>
    $(document).ready(function() {
        $(document).click(function() {
            $('.faceList').scrollTop(0)
            $('.faceList').css('display', 'none')
            $('.footer').animate({'bottom': '0'}, 300)
            $('#face_area').removeClass('open')
        })

        const socket = io() //Áî®io()ÂàõÂª∫ËøûÊé• Áî®on(),emit()ÂèëÈÄÅÂíåÊé•Êî∂Êï∞ÊçÆ
        let name = null
        let avater = ''
        const emoji = 'üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ ü§£ üòä üòá üôÇ üôÉ üòâ üòå üòç üòò üòó üòô üòö üòã üòõ üòù üòú üòé üòè üòí üòû üòî üòü üòï üôÅ üò£ üòñ üò´ üò© üò¢ üò≠ üò§ üò† üò° üò≥ üò± üò® üò∞ üò• üòì ü§ó ü§î ü§• üò∂ üòê üòë üò¨ üôÑ üòØ üò¶ üòß üòÆ üò≤ üò¥ ü§§ üò™ üòµ ü§ê ü§¢ ü§ß üò∑ ü§í ü§ï ü§ë ü§† ü§ù üëç üëé üëè Ô∏èüëå ‚õÖ ‚òÄÔ∏è üå¶Ô∏è üåßÔ∏è ‚õàÔ∏è üå©Ô∏è üå®Ô∏è üå± üåø Ô∏èüçÄ üåπ üå∏ üçÇ üçÉ üåº üê£ üê¢ üí© üëª üëæ ü§ñ üê∑ üê∂ üê± ü¶Ä ü¶ê üêû üêì';
        $('.input_name').focus()

         /*ÂêëÊúçÂä°Á´ØÂèëÈÄÅÁôªÂΩï‰∫ã‰ª∂*/
        $('#coming').click(() => {
            name = $('.input_name').val()
            if(name) {
                socket.emit('login', {
                    username: name,
                    avater
                })
                cutEmoji()
            } else {
                alert('ËØ∑ËæìÂÖ•ÂêçÂ≠ó~')
            }
            
        })
        
        //emojiÂõæÁâáÂ§ÑÁêÜ
        function cutEmoji() {
            emojione.imagePathPNG = "static/img/emoji/"
            let emojis = emoji.split(' ').filter(v => v).map(v => ({ text: v, url: emojione.unicodeToImage(v) }))
            $.each(emojis, (index, item) => { 
                $('.faceList').append(`<div class="img_con" onclick="tapFace('${item.text}')">${item.url}</div>`)
            })
        }
        
        //ÂèëÈÄÅÊú¨Âú∞ÂõæÁâá
        $('.icon-tupian1').click(() => {
            $("#fileInput").click()
        })
        
        //‰∏ä‰º†Â§¥ÂÉè
        $('.uploadAvater').click(() => {
            $('#avaterInput').click()
        })
        
        //ÂõæÁâáÂ§ÑÁêÜÂπ∂ÂèëÈÄÅ
        $("#fileInput").change((e) => {
            var file = e.target.files[0]
            var AllowImgFileSize = 1024*1024*20
            if (file) {
                var reader = new FileReader()
                var imgUrlBase64 = reader.readAsDataURL(file)
                reader.onload = function() {
                    if (AllowImgFileSize < reader.result.length) {
                        alert('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑‰∏ä‰º†‰∏çÂ§ß‰∫é20MÁöÑÂõæÁâáÔºÅ')
                        return
                    } else {
                        socket.emit('sendMessage', {
                            username: name,
                            message: this.result,
                            type: 2,
                            avater
                        })
                    }
                }
            }
        })
        
        $("#avaterInput").change((e) => {
            var file = e.target.files[0]
            var AllowImgFileSize = 1024*1024*20
            if (file) {
                var reader = new FileReader()
                var imgUrlBase64 = reader.readAsDataURL(file) 
                reader.onload = function() {
                    if (AllowImgFileSize < reader.result.length) {
                        alert('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑‰∏ä‰º†‰∏çÂ§ß‰∫é20MÁöÑÂõæÁâáÔºÅ')
                        return
                    } else {
                        avater = this.result
                        $('.uploadAvater')[0].innerHTML = `<img src=${this.result} width="100%">`;
                    }
                }
            }
        })

        let pre = document.getElementById('pre')
        let el = document.getElementById('textarea')

        $('#send').click(() => {
            let message = el.value
            if (message === "") {
                alert('ËØ∑ËæìÂÖ•‰ø°ÊÅØ')
                return
            }
            socket.emit('sendMessage', {
                username: name,
                message,
                type: 1,
                avater
            })
        })

        //Êé•Êî∂ÊúçÂä°Á´ØÁöÑ‰∫ã‰ª∂ Âå∫Âà´ÂΩìÂâçÁî®Êà∑ÂíåÂà´‰∫∫ ÂõæÁâáÊ∂àÊÅØÂíåÊñáÂ≠óÊ∂àÊÅØ
        socket.on('receiveMessage', (obj) => {
            if(obj.username === name) {
                if(obj.type === 1) {
                    $('.container').append(`
                        <li>
                            <div>
                                <img class='avater' src="${obj.avater}">
                                <div class='message floatR'>${obj.message}<span class="time">${obj.username}</span></div>
                            </div>
                        </li>`)
                    el.value = ''
                    pre.value = ''
                } else {
                    $('.container').append(`
                        <li>
                            <div>
                                <img class='avater' src="${obj.avater}">
                                <div class='message floatR'><img src="${obj.message}" /><span class="time">${obj.username}</span></div>
                            </div>
                        </li>`)
                }
            } else {
                if(obj.type === 1) {
                    $('.container').append(`
                        <li>
                            <div>
                                <img class='avater_other' src="${obj.avater}">
                                <div class='message floatL'>${obj.message}<span class="time_other">${obj.username}</span></div>
                            </div>
                        </li>`)
                } else {
                    $('.container').append(`
                        <li>
                            <div>
                                <img class='avater_other' src="${obj.avater}">
                                <div class='message floatL'><img src="${obj.message}" /><span class="time_other">${obj.username}</span></div>
                            </div>
                        </li>`)
                }
            }
            $('.container').scrollTop($('.container')[0].scrollHeight)
        })

        socket.on('login', (name) => {
            $('.header')[0].innerHTML = `Ê¨¢Ëøé‰Ω† ${name}`
            $('.mask').addClass('hide')
            $('.area').addClass('hide')
            el.focus()
        })

        socket.on('loginSuccess', (text) => {
            console.log('ÁôªÂΩïÊàêÂäü')
        })

        socket.on('loginFailed', (text) => {
            alert(text)
            $('.input_name').val('')
            $('.input_name').focus()
        })

        socket.on('add', (name) => {
            $('.container').append(`<li class='system_tips'>${name}Âä†ÂÖ•Áæ§ËÅä</li>`)
            $('.container').scrollTop($('.container')[0].scrollHeight)
        })
        
        socket.on('leave', (name) => {
            $('container').append(`<li class='system_tips' style='color:#666'>${name}ÈÄÄÂá∫Áæ§ËÅä</li>`)
            $('.container').scrollTop($('.container')[0].scrollHeight)
        })
        
        //enterÈîÆÊìç‰ΩúÂà§Êñ≠
        document.onkeydown = (event) => {
            if(event.keyCode === 13 && $('.mask').hasClass('hide')) {
                $('#send').trigger('click')
                event.preventDefault()
            } else if (event.keyCode === 13) {
                $('#coming').trigger('click')
            }
        }

        $('#face_area').click(function(e) {
            if($(this).hasClass('open')) {
                $(this).parent().next('.faceList').scrollTop(0)
                $(this).parent().next('.faceList').css({'display': 'none'})
                $('.footer').animate({'bottom': '0'}, 300)
                $(this).removeClass('open')
            } else {
                $(this).addClass('open')
                $(this).parent().next('.faceList').css({'display': 'flex', 'height': '180px'})
            }
            e.stopPropagation()
        })

        var cursur
        
        //ÊãºÊé•Ë°®ÊÉÖÊñáÂ≠ó
        tapFace = function (txt) {
            var e = window.event
            let input = pre.value
            let range = document.createRange()
            if (cursur !== undefined) {
                let frontTxt = el.value.substr(0, cursur),
                    endTxt = el.value.substr(cursur)
                input = frontTxt + txt + endTxt
                let finalCursur = cursur + txt.length
                e.target.selectionStart = finalCursur
                e.target.selectionEnd = finalCursur
                cursur = finalCursur
                range.collapse(true)
            } else {
                input += txt
            }
            pre.value = input
            el.value = input
            el.style.height = pre.scrollHeight + 'px'
            e.stopPropagation()
        }
        
        //ÁõëÂê¨input‰∫ã‰ª∂ÔºåËæìÂÖ•Ê°ÜËá™ÈÄÇÂ∫îÈ´òÂ∫¶
        $(el).on('input', function() {
            pre.value = el.value
            el.style.height = pre.scrollHeight + 'px'
        })

        $(el).click(function(e) {
            cursur = e.target.selectionStart
        })

        $(el).blur(function(e) {
            cursur = e.target.selectionStart
        })
    })
</script>

</html>